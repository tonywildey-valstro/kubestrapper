SHELL=/bin/bash
DATE=$(shell date -I)
OUT_GRAFANA=out/grafana
OUT_PROMETHEUS=out/prometheus
GRAFANA_TARGETS=$(patsubst %.jsonnet, $(OUT_GRAFANA)/%.json, $(wildcard dash*.jsonnet))
ALERT_TARGETS=$(patsubst %.jsonnet, $(OUT_PROMETHEUS)/%.rules.yml, $(wildcard alert*.jsonnet))
RULES_TARGETS=$(patsubst %.jsonnet, $(OUT_PROMETHEUS)/%.rules.yml, $(wildcard rules*.jsonnet))

GOLDEN_TARGETS=$(patsubst %.jsonnet,golden/%.json,$(ALL_JSONNET))

ALL_JSONNET=$(wildcard *.jsonnet)

PHONY_DIFF=$(patsubst %.jsonnet,%.diff,$(ALL_JSONNET))

all: $(GRAFANA_TARGETS) $(ALERT_TARGETS) $(RULES_TARGETS)

test: test-fmt golden-diff

test-fmt:
	jsonnet fmt --test $(ALL_JSONNET)

fix-fmt:
	for i in $(ALL_JSONNET); do jsonnet fmt -i $$i;done

clean:
	rm -f $(GRAFANA_TARGETS) $(ALERT_TARGETS) $(RULES_TARGETS)

$(OUT_PROMETHEUS)/%.rules.yml: $(OUT_PROMETHEUS)/%.json spec*.jsonnet
	@mkdir -p out/prometheus
	python -c 'import sys, yaml, json; print "# NOTE: This file has been autogenerated from \"$(*).jsonnet\" on $(DATE)"; yaml.safe_dump(json.load(sys.stdin), sys.stdout, default_flow_style=False)' < $(<) > $(@)

$(OUT_PROMETHEUS)/%.json $(OUT_GRAFANA)/%.json: %.jsonnet spec*.jsonnet
	@mkdir -p out/grafana out/prometheus
	jsonnet $(<) > $(@).tmp && mv $(@).tmp $(@) || rm -f $(@).tmp

golden-diff: $(PHONY_DIFF)

%.diff: %.jsonnet
	diff -u golden/$(*).json <(jsonnet $(<))

golden/%.json: %.jsonnet spec*.jsonnet
	jsonnet $(<) > $(@)

fix-golden: $(GOLDEN_TARGETS)

.PRECIOUS: %.jsonnet golden/%.json gen-golden
